import os
import re
import openpyxl
from docx import Document

def pretrazi_datoteke(mapa, ekstenzije):
    pronadjene_datoteke = []
    for root, dirs, files in os.walk(mapa):
        for file in files:
            if any(file.lower().endswith(ext) for ext in ekstenzije):
                pronadjene_datoteke.append(os.path.join(root, file))
    return pronadjene_datoteke

def pretrazi_rijeci_txt(datoteka):
    try:
        with open(datoteka, 'r', encoding='utf-8', errors='ignore') as f:
            tekst = f.read()
            rijeci = re.findall(r'\b[A-Z]\S{7,16}[^\w\s]\b', tekst)
            return rijeci
    except Exception as e:
        print(f"Pogreška pri čitanju {datoteka}: {e}")
        return []

def pretrazi_rijeci_xlsx(datoteka):
    rijeci = []
    try:
        workbook = openpyxl.load_workbook(datoteka)
        for sheet_name in workbook.sheetnames:
            sheet = workbook[sheet_name]
            for row in sheet.iter_rows():
                for cell in row:
                    if cell.value:
                        cell_text = str(cell.value)
                        rijeci.extend(re.findall(r'\b[A-Z]\S{7,16}[^\w\s]\b', cell_text))
        return rijeci
    except Exception as e:
        print(f"Pogreška pri čitanju {datoteka}: {e}")
        return []

def pretrazi_rijeci_docx(datoteka):
    rijeci = []
    try:
        doc = Document(datoteka)
        for paragraph in doc.paragraphs:
            rijeci.extend(re.findall(r'\b[A-Z]\S{7,16}[^\w\s]\b', paragraph.text))
        return rijeci
    except Exception as e:
        print(f"Pogreška pri čitanju {datoteka}: {e}")
        return []

def zapisivanje_u_datoteku(rijeci_i_putanje, izlazna_datoteka):
    vec_zapisane_rijeci = set()
    sortirane_rijeci_i_putanje = sorted(rijeci_i_putanje, key=lambda x: len(x[0]))
    with open(izlazna_datoteka, 'w', encoding='utf-8') as f:
        for rijec, putanja in sortirane_rijeci_i_putanje:
            if rijec not in vec_zapisane_rijeci:
                f.write(f'{rijec} {putanja}\n')
                vec_zapisane_rijeci.add(rijec)

if __name__ == "__main__":
    mapa_c = r'C:\Users\HR49010\OneDrive - Emil Frey Group'
    ekstenzije = ['.txt', '.xlsx', '.docx']
    izlazna_datoteka = 'rezultati.txt'

    pronadjene_datoteke = pretrazi_datoteke(mapa_c, ekstenzije)
    rijeci_i_putanje = []

    for datoteka in pronadjene_datoteke:
        if datoteka.lower().endswith('.txt'):
            rijeci = pretrazi_rijeci_txt(datoteka)
        elif datoteka.lower().endswith('.xlsx'):
            rijeci = pretrazi_rijeci_xlsx(datoteka)
        elif datoteka.lower().endswith('.docx'):
            rijeci = pretrazi_rijeci_docx(datoteka)
        for rijec in rijeci:
            rijeci_i_putanje.append((rijec, datoteka))

    zapisivanje_u_datoteku(rijeci_i_putanje, izlazna_datoteka)

    print(f'Pronađene jedinstvene riječi i putanje sortirane po dužini zapisane u {izlazna_datoteka}.')
